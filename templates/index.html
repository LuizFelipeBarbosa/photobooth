<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>THE OCHO Photobooth</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>THE OCHO</h1>
            <p class="subtitle">PHOTOBOOTH</p>
        </header>

        <div id="status" class="status ready">
            <span class="status-icon">üì∑</span>
            <span class="status-text">Ready to capture!</span>
        </div>

        <div id="countdown-display" class="countdown-display hidden"></div>

        <div class="buttons">
            <button id="photoBtn" class="btn btn-primary" onclick="takePhoto()">
                <span class="btn-icon">üì∏</span>
                <span class="btn-text">Single Photo</span>
            </button>
            
            <button id="stripBtn" class="btn btn-secondary" onclick="takeStrip()">
                <span class="btn-icon">üéûÔ∏è</span>
                <span class="btn-text">Photo Strip</span>
                <span class="btn-subtitle">3 Photos</span>
            </button>
        </div>

        <div class="info">
            <p>üìç Look at the computer camera!</p>
            <p>Photos will print automatically</p>
        </div>
    </div>

    <div id="flash" class="flash"></div>

    <div id="photo-modal" class="modal hidden">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">√ó</button>
            <h2>Great Shot! üéâ</h2>
            <div class="photo-container">
                <img id="result-photo" src="" alt="Captured Photo">
            </div>
            <p class="print-msg">Printing your photo...</p>
        </div>
    </div>

    <script>
        let polling = null;
        let countdownInterval = null;
        const COUNTDOWN_SECONDS = 3;

        async function takePhoto() {
            startFlow(3, 'üì∏ Single Photo', '/api/photo');
        }

        async function takeStrip() {
            // Photo strip takes longer to process, but the first capture is fast-ish
            // The backend for strip capture is tricky because it does 3 photos.
            // For now, let's keep the simple countdown but maybe extend the "Processing" state.
            startFlow(3, 'üéûÔ∏è Photo Strip', '/api/strip');
        }

        async function startFlow(seconds, mode, apiEndpoint) {
            if (document.getElementById('photoBtn').disabled) return;
            
            disableButtons();
            
            // 1. Start the backend process IMMEDIATELY (it takes ~2.5s to warm up camera)
            // We don't await this yet so the UI updates concurrently
            const fetchPromise = fetch(apiEndpoint, { method: 'POST' });
            
            // 2. Start Visual Countdown
            showCountdown(seconds, mode);

            try {
                const response = await fetchPromise;
                const data = await response.json();
                
                if (response.ok) {
                    // Backend has started successfully
                    startPolling();
                } else {
                    hideCountdown();
                    updateStatus('error', '‚ùå', data.message);
                    enableButtons();
                }
            } catch (error) {
                hideCountdown();
                updateStatus('error', '‚ùå', 'Connection error');
                enableButtons();
            }
        }

        function showCountdown(seconds, mode) {
            let remaining = seconds;
            const display = document.getElementById('countdown-display');
            display.classList.remove('hidden');
            display.textContent = remaining;
            updateStatus('capturing', 'üì∑', `${mode} - Get ready!`);
            
            countdownInterval = setInterval(() => {
                remaining--;
                
                if (remaining > 0) {
                    display.textContent = remaining;
                    updateStatus('capturing', '‚è±Ô∏è', `Look at the camera! ${remaining}...`);
                } else if (remaining === 0) {
                    // FLASH!
                    display.textContent = 'üì∏';
                    triggerFlash();
                    updateStatus('capturing', 'üì∏', 'Capturing... Smile!');
                } else {
                    // Wait phase (after 0)
                    display.textContent = 'üñ®Ô∏è'; // Or spinner
                    updateStatus('capturing', 'üñ®Ô∏è', 'Processing & printing...');
                    
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
            }, 1000);
        }

        function triggerFlash() {
            const flash = document.getElementById('flash');
            flash.classList.add('active');
            setTimeout(() => {
                flash.classList.remove('active');
            }, 200);
        }

        function hideCountdown() {
            const display = document.getElementById('countdown-display');
            display.classList.add('hidden');
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        function startPolling() {
            if (polling) clearInterval(polling);
            
            polling = setInterval(async () => {
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        hideCountdown();
                        stopPolling();
                        
                        // Show result!
                        if (data.photo_url) {
                            showModal(data.photo_url);
                        } else {
                            updateStatus('success', 'üéâ', data.message);
                            setTimeout(() => {
                                updateStatus('ready', 'üì∑', 'Ready to capture!');
                                enableButtons();
                            }, 3000);
                        }

                    } else if (data.status === 'error') {
                        hideCountdown();
                        updateStatus('error', '‚ùå', data.message);
                        stopPolling();
                        enableButtons();
                    }
                } catch (error) {
                    // Keep polling
                }
            }, 500);
        }

        function stopPolling() {
            if (polling) {
                clearInterval(polling);
                polling = null;
            }
        }

        function showModal(url) {
            const modal = document.getElementById('photo-modal');
            const img = document.getElementById('result-photo');
            img.src = url + '?t=' + new Date().getTime(); // Prevent caching
            modal.classList.remove('hidden');
            modal.classList.add('visible');
            
            updateStatus('success', 'üéâ', 'Printed successfully!');
        }

        function closeModal() {
            const modal = document.getElementById('photo-modal');
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.classList.add('hidden');
                updateStatus('ready', 'üì∑', 'Ready to capture!');
                enableButtons();
            }, 300);
        }

        function updateStatus(type, icon, message) {
            const status = document.getElementById('status');
            status.className = 'status ' + type;
            status.querySelector('.status-icon').textContent = icon;
            status.querySelector('.status-text').textContent = message;
        }

        function disableButtons() {
            document.getElementById('photoBtn').disabled = true;
            document.getElementById('stripBtn').disabled = true;
            document.body.classList.add('busy');
        }

        function enableButtons() {
            document.getElementById('photoBtn').disabled = false;
            document.getElementById('stripBtn').disabled = false;
            document.body.classList.remove('busy');
        }

        // Check initial status
        fetch('/api/status').then(r => r.json()).then(data => {
            if (data.in_progress) {
                disableButtons();
                startPolling();
            }
        });
    </script>
</body>
</html>
